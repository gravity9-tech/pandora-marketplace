---
description: Sync documentation to Claude Code skills for on-demand context loading. Regenerates skills from wiki or any markdown directory.
argument-hint: <context_path> [skill_name]
allowed-tools: Read, Write, Bash, Glob
model: haiku
---

# DeepWiki Sync Command

Sync documentation to Claude Code skills. Use this to regenerate skills after manually enriching wiki content, or to create skills from any markdown directory structure.

## Pandora Marketplace Skill Tracking

All skills generated by this command are tracked using three mechanisms:

### 1. Prefix Convention
All skill names are prefixed with `pandora-` to distinguish them from user-created skills:
```
~/.claude/skills/pandora-{section}/SKILL.md
```

### 2. Frontmatter Metadata
Each SKILL.md includes tracking metadata in the YAML frontmatter:
```yaml
_generator: pandora-marketplace
_source_project: /absolute/path/to/project
_generated_at: 2026-01-27T10:30:00Z
```

### 3. Registry File
All pandora-generated skills are tracked in a central registry:
```
~/.claude/skills/.pandora-registry.json
```

## CRITICAL: Skill Directory Structure

Claude Code ONLY discovers skills in this exact structure:

```
~/.claude/skills/pandora-{skill-name}/SKILL.md   ✓ CORRECT - will be discovered
~/.claude/skills/{skill-name}.md                  ✗ WRONG - will NOT be discovered
```

**You MUST create a subdirectory for each skill with `pandora-` prefix.** Always use:
1. `mkdir -p ~/.claude/skills/pandora-{skill-name}/`
2. Write to `~/.claude/skills/pandora-{skill-name}/SKILL.md`

**NEVER create flat `.md` files directly in `~/.claude/skills/`.**

## Input Parameters

- **Argument 1** (`$1` - required): `context_path` - Directory containing markdown documentation
- **Argument 2** (`$2` - optional): `skill_name` - Custom skill name (only for single-directory mode)

---

## Phase 0: CLAUDE.md Setup and Skill Discovery

Before syncing new skills, ensure CLAUDE.md exists and register ALL existing skills.

### Step 1: Check for CLAUDE.md

```bash
test -f ./CLAUDE.md && echo "exists" || echo "missing"
```

### Step 2: If CLAUDE.md is missing, run /init to create it

Display message and run the built-in `/init` command:

```
⚠ CLAUDE.md not found in project root.

Running /init to generate CLAUDE.md...
```

**Run the `/init` command** using the Skill tool:

```
Skill: init
```

This will:
- Analyze the project structure
- Read package files, configs, and existing documentation
- Generate a proper CLAUDE.md with build commands, test instructions, coding conventions, etc.

**Wait for /init to complete** before proceeding to Step 3.

### Step 3: If CLAUDE.md exists but has no Skills section

Check if CLAUDE.md contains a `## Skills` section:

```bash
grep -q "## Skills" ./CLAUDE.md && echo "has_skills" || echo "no_skills"
```

If no Skills section exists, append it to CLAUDE.md.

### Step 4: Discover ALL existing pandora skills in ~/.claude/skills/

Scan for all existing pandora-generated skills:

```bash
find "${HOME}/.claude/skills" -mindepth 1 -maxdepth 1 -type d -name "pandora-*" 2>/dev/null | sort
```

Also check the registry file for tracking information:

```bash
cat "${HOME}/.claude/skills/.pandora-registry.json" 2>/dev/null || echo '{"version":"1.0","skills":{}}'
```

### Step 5: For each discovered pandora skill, extract description and register

For each `pandora-*` skill directory found:

1. **Read the SKILL.md file:**
   ```bash
   cat "${HOME}/.claude/skills/pandora-{section}/SKILL.md"
   ```

2. **Extract the description** from YAML front matter:
   - Parse the `description:` field from the `---` delimited front matter
   - This contains the skill's trigger conditions

3. **Check if already registered in CLAUDE.md:**
   ```bash
   grep -q "| pandora-{section} |" ./CLAUDE.md && echo "registered" || echo "not_registered"
   ```

4. **If not registered, add to skills table:**
   - Insert row before `<!-- Skills are automatically registered` comment
   - Format: `| pandora-{section} | {description} |`

5. **If already registered, verify description is current** (update if changed)

### Step 6: Display discovered skills

```
✓ CLAUDE.md ready

Existing pandora skills discovered:
  pandora-overview       → registered
  pandora-architecture   → registered
  pandora-features       → registered
  pandora-api            → registered
  pandora-development    → already registered

Registry: ~/.claude/skills/.pandora-registry.json (5 skills tracked)

Proceeding with sync...
```

---

## Phase 1: Sync Requested Content

### Mode Detection

Check if `{context_path}` contains subdirectories (excluding `.temp`):

```bash
find {context_path} -mindepth 1 -maxdepth 1 -type d ! -name '.temp' | wc -l
```

- **If subdirectories exist** → Multi-skill mode (one skill per subdirectory)
- **If no subdirectories** → Single-skill mode (one skill for the entire directory)

---

### Multi-Skill Mode

When `{context_path}` has subdirectories (e.g., `./wiki/` with `overview/`, `architecture/`, etc.):

1. **Discover sections:**
   ```bash
   find {context_path} -mindepth 1 -maxdepth 1 -type d ! -name '.temp' | sort
   ```

2. **For each section directory**, generate a skill:
   - Skill name: `pandora-{section_name}`
   - Skill path: `{home}/.claude/skills/pandora-{section_name}/SKILL.md`

3. **Generate SKILL.md** for each section using the template below

4. **Update the pandora registry** (see Registry Management section)

5. **Register each skill in CLAUDE.md** (see Skill Registration Reference)

6. **Display results:**
   ```
   ✓ Skills synced from {context_path}

     pandora-overview       3 files  → registered in CLAUDE.md
     pandora-architecture   5 files  → registered in CLAUDE.md
     pandora-features       5 files  → registered in CLAUDE.md
     ...

   Skills location: {home}/.claude/skills/
   Registry: {home}/.claude/skills/.pandora-registry.json
   CLAUDE.md updated: ./CLAUDE.md
   ```

---

### Single-Skill Mode

When `{context_path}` has no subdirectories (e.g., `./wiki/my-custom-context/`):

1. **Determine skill name:**
   - If `$2` provided: use `pandora-{$2}`
   - Otherwise: use `pandora-{directory_name}`

2. **List all markdown files:**
   ```bash
   find {context_path} -name "*.md" -type f | sort
   ```

3. **Generate single SKILL.md** at `{home}/.claude/skills/pandora-{name}/SKILL.md`

4. **Update the pandora registry** (see Registry Management section)

5. **Register skill in CLAUDE.md** (see Skill Registration Reference)

6. **Display results:**
   ```
   ✓ Skill synced from {context_path}

     pandora-{name}   {N} files  → registered in CLAUDE.md

   Skill location: {home}/.claude/skills/pandora-{name}/
   Registry: {home}/.claude/skills/.pandora-registry.json
   CLAUDE.md updated: ./CLAUDE.md
   ```

---

## SKILL.md Template

```markdown
---
name: pandora-{section}
description: {generated_description}
user-invocable: false
allowed-tools: Read, Glob
# Pandora Marketplace tracking metadata (auto-generated)
_generator: pandora-marketplace
_source_project: {absolute_project_path}
_generated_at: {ISO_timestamp}
---

# {Section Title} Context

This skill provides context from the project documentation.

## Available Documentation

Read the following files from `{relative_context_path}/{section}/` for context:

| File | Purpose |
|------|---------|
| {filename} | {file_purpose} |
...

## When to Use

- {trigger_1}
- {trigger_2}
- {trigger_3}

## Instructions

1. Read the relevant file(s) based on the user's question
2. Use this context to inform your response
3. Maintain consistency with documented patterns
```

**Template Notes:**
- `{absolute_project_path}` is the absolute path to the current project (use `pwd`)
- `{ISO_timestamp}` is the current timestamp in ISO 8601 format (e.g., `2026-01-27T10:30:00Z`)

### Description Generation

Generate descriptions based on section name patterns:

| Pattern | Description |
|---------|-------------|
| `overview*` | System overview, technology stack, and domain glossary. Use when understanding project purpose or tech stack. |
| `architect*` | System architecture, component relationships, and design patterns. Use when making architectural decisions. |
| `feature*` | Feature documentation and behavior. Use when working on or understanding existing features. |
| `develop*` | Development setup, coding standards, and workflows. Use when setting up or following conventions. |
| `test*` | Testing strategy and execution. Use when writing or running tests. |
| `deploy*` | Build process and environments. Use when building for production or configuring deployments. |
| `domain*` | Business domain knowledge. Use when understanding business requirements or terminology. |
| `service*` | Service documentation. Use when working on specific services or understanding boundaries. |
| `integrat*` | External integrations. Use when working with third-party services or APIs. |
| `security*` | Security patterns and configurations. Use when handling auth, secrets, or security concerns. |
| `operat*` | Operations and monitoring. Use when dealing with logs, metrics, or incident response. |
| `api*` | API documentation and endpoints. Use when working with or designing APIs. |
| `data*` | Data models and database schemas. Use when working with data structures. |
| (other) | `{Section name} documentation. Use when working on {section name} related tasks.` |

### File Purpose Extraction

For each markdown file:
1. Try to read YAML front matter `description` field
2. If not found, convert filename from kebab-case to sentence case

### When to Use Generation

Based on section type, generate 3-5 relevant trigger scenarios.

---

## Registry Management

Before registering skills in CLAUDE.md, update the pandora registry.

### Registry File Location

`{home}/.claude/skills/.pandora-registry.json`

### Registry Operations

1. **Read existing registry:**
   ```bash
   cat "${HOME}/.claude/skills/.pandora-registry.json" 2>/dev/null || echo '{"version":"1.0","skills":{}}'
   ```

2. **For each skill being synced**, add/update entry:
   ```json
   {
     "version": "1.0",
     "skills": {
       "pandora-overview": {
         "generator": "deepwiki",
         "source_project": "/absolute/path/to/project",
         "context_path": "/absolute/path/to/wiki",
         "created_at": "2026-01-27T10:30:00Z",
         "updated_at": "2026-01-27T10:30:00Z"
       }
     }
   }
   ```

3. **Write updated registry** back to file

---

## Skill Registration (Reference)

This section documents how to register skills in CLAUDE.md. Used by both Phase 0 (existing skills) and Phase 1 (newly synced skills).

### For Each Skill

1. **Read current CLAUDE.md content**

2. **Check if skill already registered:**
   ```bash
   grep -q "| pandora-${section} |" ./CLAUDE.md && echo "registered" || echo "not_registered"
   ```

3. **If not registered, add to skills table:**

   Find the line containing `<!-- Skills are automatically registered` and insert the skill row before it:

   ```markdown
   | pandora-{section} | {skill_description} |
   ```

   Example skill rows:
   ```markdown
   | pandora-overview | System overview, tech stack, glossary. Invoke when asking about project purpose or technologies. |
   | pandora-architecture | System architecture and design patterns. Invoke when making architectural decisions. |
   | pandora-features | Feature documentation. Invoke when working on or understanding existing features. |
   | pandora-development | Development setup and coding standards. Invoke when setting up environment or following conventions. |
   | pandora-api | API documentation and endpoints. Invoke when working with APIs. |
   ```

4. **If skill already registered, update the description** (in case it changed)

### CLAUDE.md Skills Table Format

The skills table in CLAUDE.md should look like:

```markdown
## Skills

The following context skills are available. When a query matches a skill's purpose, invoke it using the Skill tool to load relevant documentation before responding.

| Skill | When to Use |
|-------|-------------|
| pandora-overview | System overview, tech stack, glossary. Invoke when asking about project purpose or technologies. |
| pandora-architecture | System architecture and design patterns. Invoke when making architectural decisions. |
| pandora-features | Feature documentation. Invoke when working on or understanding existing features. |
<!-- Skills are automatically registered by /deepwiki:sync -->
```

### Skill Description for CLAUDE.md

Generate a concise "When to Use" description (under 100 chars):

| Pattern | CLAUDE.md Description |
|---------|----------------------|
| `overview*` | System overview, tech stack, glossary. Invoke when asking about project purpose or technologies. |
| `architect*` | System architecture and design patterns. Invoke when making architectural decisions. |
| `feature*` | Feature documentation. Invoke when working on or understanding existing features. |
| `develop*` | Development setup and coding standards. Invoke when setting up environment or following conventions. |
| `test*` | Testing strategy. Invoke when writing or running tests. |
| `deploy*` | Deployment and environments. Invoke when building or deploying. |
| `api*` | API documentation and endpoints. Invoke when working with APIs. |
| (other) | {Section name} docs. Invoke when working on {section name} tasks. |

---

## Example Usage

```bash
# Sync all sections from a wiki
/deepwiki:sync ./wiki

# Sync a single custom context directory
/deepwiki:sync ./docs/my-custom-context

# Sync with custom skill name
/deepwiki:sync ./notes/project-decisions decisions
```

## Use Cases

1. **After manual edits:** User enriches wiki content, runs `/deepwiki:sync ./wiki` to update skills

2. **Custom context:** User creates `./docs/team-conventions/` with markdown files, runs `/deepwiki:sync ./docs/team-conventions conventions`

3. **Partial update:** User updates only architecture docs, runs `/deepwiki:sync ./wiki/architecture` to regenerate just that skill

4. **Non-wiki content:** User has existing markdown docs in `./documentation/`, runs `/deepwiki:sync ./documentation` to create skills from it

## Notes

- Skills are always written to `{home}/.claude/skills/pandora-{name}/SKILL.md` (subdirectory with prefix required)
- All skills use the `pandora-` prefix to distinguish from user-created skills
- Each SKILL.md contains tracking metadata (`_generator`, `_source_project`, `_generated_at`)
- All skills are tracked in `{home}/.claude/skills/.pandora-registry.json`
- Running again overwrites existing skills with same names and updates registry
- Excludes `.temp/` directories
- Only processes `.md` files
- CLAUDE.md is created if missing, or updated if it exists
- Skills are registered in CLAUDE.md for auto-discovery
- Use `/deepwiki:skills` to list and manage pandora-generated skills

## Verification

After writing skills, verify the structure is correct:

```bash
# Should show pandora-* directories
ls -la ~/.claude/skills/ | grep pandora-

# Should list SKILL.md files inside pandora-* subdirectories
find ~/.claude/skills -path "*/pandora-*/*" -name "SKILL.md" -type f

# Verify registry exists and contains skills
cat ~/.claude/skills/.pandora-registry.json | head -10

# Verify CLAUDE.md has skills registered with pandora- prefix
grep "| pandora-overview |" ./CLAUDE.md && echo "✓ Skills registered in CLAUDE.md"
```

If you see `.md` files directly in `~/.claude/skills/` (not inside subdirectories), the structure is wrong and skills will not be discovered.

## How Skill Discovery Works

After sync completes, Claude discovers skills through two mechanisms:

1. **CLAUDE.md Skills Table**: Claude reads CLAUDE.md at session start and sees the skills table, which tells it which `pandora-*` skills exist and when to use them.

2. **Lazy Loading**: When Claude identifies a matching query (e.g., "explain the architecture"), it invokes the `pandora-architecture` skill using the Skill tool. The skill's SKILL.md tells Claude which documentation files to read.

This two-step approach keeps context minimal until needed:
- CLAUDE.md: ~50 lines (just skill names and triggers)
- SKILL.md: Loaded on-demand with file references
- Wiki docs: Read only when the skill is invoked

## Pandora Skill Tracking

All skills generated by this sync are tracked three ways:

1. **Prefix**: Skill directories are named `pandora-{section}` to distinguish from user-created skills
2. **Frontmatter Metadata**: Each SKILL.md contains:
   - `_generator: pandora-marketplace`
   - `_source_project: /path/to/project`
   - `_generated_at: ISO_timestamp`
3. **Registry File**: `~/.claude/skills/.pandora-registry.json` tracks all pandora skills

Use `/deepwiki:skills` to list and manage pandora-generated skills.
